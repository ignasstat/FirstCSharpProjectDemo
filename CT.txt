ALTER View [dbo].[vw_CallTraceFilesToDisplay_New_Test] as


WITH RunStatusForJobs AS (
   select distinct CT_JobID,FileID from dbo.CT_JobRun where RunStatus not in ('Neptune Complete', 'In QC', 'Verified','Cancelled', 'Complete')
)


WITH DPPLaunch AS (
	select nv.varValue as Environment, ce.[Enabled]
		from		Neptune.dbo.NeptuneVariables nv
		inner join	Cobra.Environments ce
			on nv.varName = 'DPP_Default_BatchWorkflowEndpoint' and nv.varValue = ce.Environment
)

select top 1000 
	CASE WHEN COUNT(JN.Job_Number) = 0 THEN 'No Matches' 
	WHEN COUNT(JN.Job_Number) > 1 THEN 'Multiple Matches' 
	ELSE MAX(JN.Job_Number) 
END AS Job_Number,
	v.fileid, 
	v.Source, 
	cast(Replace(Replace(Replace(Replace(Replace(Replace(v.Folder, '\\cig.local\Data\Marketing Solutions Departments\Production\Data In\','<Data In>\'),
		'\\cig.local\Data\Marketing Solutions Departments\Production\Public\DataTransfer\Inbound\FromClientManagement\calltrace\','<Internal CMT>\'), 
		'\\cig.local\Data\Marketing Solutions Departments\Production\Public\DataTransfer\Inbound\FromDOTO\calltrace\','<Internal DOTO>\'), 
		'\\cig.local\Data\Marketing Solutions Departments\Production\Neptune\CallTrace\InTouch\','<InTouch>\'), 
		'\\cig.local\Data\Marketing Solutions Departments\Production\Public\DataTransfer\InBound\FromSDQ\CallTrace','<Internal SDQ>\'),
		'\\cig.local\data\AppData\SFTP\Data\Usr\Credit\','<EFT>\')
		as varchar(255))
	Folder,
	v.filename,
	format(v.Supplieddate, 'yyyy-MM-dd HH:mm') as ReceivedDate,
	v.filesize,
	CASE
		WHEN EXISTS (Select 1 from dbo.CT_Config where ConfigItem = 'Launch Enabled' and ConfigValue = 'True') THEN 'True'
		ELSE 'False'
	END AS NewColumn
from dbo.vw_ExistingFiles_New v
left join dbo.CT_RejectedFiles r
	on r.fileID = v.FileID and r.FileSource = v.Source and r.UnRejectedDate is null
left join dbo.CT_JobRun JR
	on jr.fileID = v.FileID and jr.FileSource = v.Source 
full outer join dbo.vw_CallTraceJobList JN
	on jn.InboundFolder = Folder and v.FileName like jn.InboundFileSpec
left join RunStatusForJobs FR
	on fr.FileID = v.FileID
where r.fileid is null and jr.fileid is null and v.FileID is not null --jr.fileid is null won't work, need additional query , Max(runid) where same jobID and jobstatus is not "**" if exists then cannot launch otherwise allowed and join to this query based on fileID,
GROUP BY 
	v.fileid, 
	v.Source, 
	Folder, 
	v.filename, 
	v.createddate, 
	v.updateddate, 
	v.Supplieddate, 
	v.filesize
ORDER BY Updateddate;
