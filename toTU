function Create-TriggerFile {
    param(
        [string]$GUIDString,
        [ref]$ActionListNames,
        [string]$SaveLocation,
        [ref]$NodeStep,
        [string]$DestinationFolder,
        [string]$JobNumber,
        [string]$JobClient
    )

    # Create an XML document with a root element
    $xmlDoc = New-Object System.Xml.XmlDocument
    $root = $xmlDoc.CreateElement("EFT_Action")
    $xmlDoc.AppendChild($root) | Out-Null


    # Add nodes with static and dynamic values
    Add-XMLNode $root "ProcessPriority" "50"
    Add-XMLNode $root "GUID" $GUIDString
    Add-XMLNode $root "StepSequence" ([string]$NodeStep.Value)
    Add-XMLNode $root "CreationDTS" (Get-Date -Format "yyyy-MM-dd HH:mm:ss")
    Add-XMLNode $root "RetriesRemaining" "2"
    Add-XMLNode $root "LastAttemptDTS" ""
    Add-XMLNode $root "LastResult" ""
    Add-XMLNode $root "FailureNotificationEmail" ""

    # Populate FailureNotificationEmail with more details
    $emailNode = $root.LastChild
    Add-XMLNode $emailNode "To" "DataOperationsEFT-CD@transunion.co.uk"
    Add-XMLNode $emailNode "CC" "DataBureau@transunion.co.uk"
    Add-XMLNode $emailNode "BCC" ""
    Add-XMLNode $emailNode "Subject" "DTP - $JobClient - $JobNumber - Completed Transfer trigger creation - Failed"
    Add-XMLNode $emailNode "Message" "The DTP has failed at creating completed file transfer trigger file in $DestinationFolder."

    # Add bespoke command to create a trigger file
    $triggerFilePath = Join-Path -Path $DestinationFolder -ChildPath "$JobNumber`_$JobClient.trg"
    Add-XMLNode $root "ActionType" "BespokeCommand"
    Add-XMLNode $root "SourceFile" "Trigger File | Out-File -FilePath '$triggerFilePath'"
    
    # Save the XML to a file
    $formattedNodeStep = "{0:D2}" -f $NodeStep.Value
    $xmlPath = Join-Path -Path $SaveLocation -ChildPath "50_$GUIDString_$formattedNodeStep.xml"
    $xmlDoc.Save($xmlPath)
    $ActionListNames.Value += "$xmlPath;"
    
    # Increment the step
    $NodeStep.Value += 1
}

function Add-XMLNode {
    param (
        [System.Xml.XmlDocument]$XML_Doc,
        [System.Xml.XmlElement]$XML_BaseElement,
        [string]$NodeName,
        [string]$NodeValue
    )

    # Create the XML Element
    $XML_Element = $XML_Doc.CreateElement($NodeName)

    # Append the new element to the base element
    $XML_BaseElement.AppendChild($XML_Element) | Out-Null

    # Set the text value of the new element
    $XML_Element.InnerText = $NodeValue
}
